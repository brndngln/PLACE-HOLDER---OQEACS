# ╔══════════════════════════════════════════════════════════════════════════════════════╗
# ║  WOODPECKER CI — Parallel Pipeline Configuration                                    ║
# ║  OMNI QUANTUM ELITE v3.0                                                           ║
# ╚══════════════════════════════════════════════════════════════════════════════════════╝
# 40-60% faster via parallel tier execution

when:
  - event: [push, pull_request, manual]

variables:
  - &python_image python:3.12-slim
  - &node_image node:20-slim

steps:
  # ═══════════════════════════════════════════════════════════════
  # TIER 1 — No dependencies, run in parallel
  # ═══════════════════════════════════════════════════════════════
  
  lint:
    image: *python_image
    group: tier1
    commands:
      - pip install ruff --quiet
      - ruff check . --fix --output-format=github
    
  typecheck:
    image: *python_image
    group: tier1
    commands:
      - pip install mypy --quiet
      - mypy . --ignore-missing-imports --no-error-summary
    
  format-check:
    image: *python_image
    group: tier1
    commands:
      - pip install black --quiet
      - black --check --diff .

  # ═══════════════════════════════════════════════════════════════
  # TIER 2 — Depends on Tier 1
  # ═══════════════════════════════════════════════════════════════
  
  unit-tests:
    image: *python_image
    group: tier2
    depends_on: [lint, typecheck, format-check]
    commands:
      - pip install -r requirements.txt pytest pytest-cov --quiet
      - pytest tests/unit -v --tb=short --cov=src --cov-report=term-missing
    
  sast:
    image: returntocorp/semgrep:1.86.0
    group: tier2
    depends_on: [lint, typecheck, format-check]
    commands:
      - semgrep scan --config=auto --error --json --output=semgrep-results.json .
    
  secret-scan:
    image: zricethezav/gitleaks:v8.18.4
    group: tier2
    depends_on: [lint, typecheck, format-check]
    commands:
      - gitleaks detect --no-git --source . --report-format json --report-path gitleaks-results.json

  # ═══════════════════════════════════════════════════════════════
  # TIER 3 — Depends on Tier 2
  # ═══════════════════════════════════════════════════════════════
  
  integration-tests:
    image: *python_image
    group: tier3
    depends_on: [unit-tests, sast, secret-scan]
    commands:
      - pip install -r requirements.txt pytest testcontainers --quiet
      - pytest tests/integration -v --tb=short
    
  mutation-testing:
    image: *python_image
    group: tier3
    depends_on: [unit-tests]
    commands:
      - pip install mutmut --quiet
      - mutmut run --paths-to-mutate=src/ --no-progress || true
      - mutmut results

  # ═══════════════════════════════════════════════════════════════
  # TIER 4 — Sequential final stages
  # ═══════════════════════════════════════════════════════════════
  
  security-review:
    image: aquasec/trivy:0.52.1
    depends_on: [integration-tests, mutation-testing]
    commands:
      - trivy fs . --severity HIGH,CRITICAL --exit-code 1

  build-image:
    image: docker:24-dind
    depends_on: [security-review]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    commands:
      - docker build -t ${CI_REPO_NAME}:${CI_COMMIT_SHA:0:8} .
      - docker tag ${CI_REPO_NAME}:${CI_COMMIT_SHA:0:8} ${CI_REPO_NAME}:${CI_COMMIT_SHA}

  deploy-preview:
    image: curlimages/curl:8.8.0
    depends_on: [build-image]
    commands:
      - |
        curl -X POST ${MATTERMOST_WEBHOOK_URL} \
          -H "Content-Type: application/json" \
          -d '{"text":"✅ Pipeline complete for '${CI_REPO_NAME}' @ '${CI_COMMIT_SHA:0:8}'"}'
    when:
      - event: [push]
        branch: [main, master]
