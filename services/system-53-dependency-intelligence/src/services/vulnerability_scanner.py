from __future__ import annotations

import httpx

from src.models import DependencyTree, VulnerabilityInfo


class VulnerabilityScanner:
    async def scan_vulnerabilities(self, tree: DependencyTree) -> list[VulnerabilityInfo]:
        findings: list[VulnerabilityInfo] = []
        async with httpx.AsyncClient(timeout=10.0) as client:
            for node in tree.nodes:
                query = {
                    "package": {"name": node.name, "ecosystem": self._ecosystem(node.ecosystem)},
                    "version": node.version,
                }
                try:
                    resp = await client.post("https://api.osv.dev/v1/query", json=query)
                    resp.raise_for_status()
                    vulns = resp.json().get("vulns", [])
                    for v in vulns[:5]:
                        sev = self._severity(v)
                        findings.append(
                            VulnerabilityInfo(
                                package=node.name,
                                version=node.version,
                                cve=v.get("id", "UNKNOWN"),
                                severity=sev,
                                summary=v.get("summary", ""),
                            )
                        )
                except Exception:
                    continue
        return findings

    @staticmethod
    def _ecosystem(name: str) -> str:
        return {"pypi": "PyPI", "npm": "npm", "crates": "crates.io"}.get(name, "PyPI")

    @staticmethod
    def _severity(vuln: dict) -> str:
        text = str(vuln).lower()
        if "critical" in text:
            return "critical"
        if "high" in text:
            return "high"
        if "moderate" in text or "medium" in text:
            return "medium"
        return "low"
