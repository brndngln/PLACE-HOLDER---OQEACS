networks:
  omni-quantum-network:
    external: true

volumes:
  policy_engine_data:
    driver: local
  policy_engine_policies:
    driver: local

services:
  policy-engine:
    build:
      context: .
      dockerfile: Dockerfile
    image: omni-policy-engine:${VERSION:-1.0.0}
    container_name: omni-policy-engine
    hostname: omni-policy-engine
    env_file:
      - ../../.env
    environment:
      SERVICE_NAME: policy-engine
      SERVICE_PORT: "9652"
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      DATA_PATH: /app/data/policies.json
      POLICIES_DIR: /app/policies
      OPA_URL: http://omni-opa:8181
      OPA_SYNC_ENABLED: ${OPA_SYNC_ENABLED:-true}
    ports:
      - "8337:9652"
    volumes:
      - policy_engine_data:/app/data
      - policy_engine_policies:/app/policies
    networks:
      - omni-quantum-network
    depends_on:
      opa:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; r=httpx.get('http://localhost:9652/health', timeout=5.0); raise SystemExit(0 if r.status_code==200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.25"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      omni.quantum.component: policy-engine
      omni.quantum.tier: security
      omni.quantum.critical: "true"

  opa:
    image: openpolicyagent/opa:0.68.0
    container_name: omni-opa
    hostname: omni-opa
    command: ["run", "--server", "--addr=0.0.0.0:8181", "/policies"]
    volumes:
      - policy_engine_policies:/policies
      - ./policies:/bootstrap-policies:ro
    ports: []
    networks:
      - omni-quantum-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8181/health >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.25"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    labels:
      omni.quantum.component: opa
      omni.quantum.tier: security
      omni.quantum.critical: "true"
