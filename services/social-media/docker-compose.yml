version: "3.9"

networks:
  omni-quantum-network:
    external: true

volumes:
  social_media_data:
    driver: local

services:
  social-media:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_DATE: "${BUILD_DATE:-2026-02-11T00:00:00Z}"
        VERSION: "${VERSION:-1.0.0}"
    image: omni-social-media:${VERSION:-1.0.0}
    container_name: omni-social-media
    hostname: omni-social-media
    env_file:
      - ../../.env
    environment:
      SERVICE_NAME: "social-media"
      SERVICE_PORT: "9641"
      VERSION: "${VERSION:-1.0.0}"
      LOG_LEVEL: "${LOG_LEVEL:-info}"
      LOG_FORMAT: "json"
      DATABASE_URL: "postgresql+asyncpg://${GI_DB_USER:-omni}:${GI_DB_PASSWORD}@omni-gi-postgres:5432/social_media_db"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@omni-redis:6379/17"
      LITELLM_URL: "http://omni-litellm:4000"
      LITELLM_API_KEY: "${LITELLM_API_KEY}"
      QDRANT_URL: "http://omni-qdrant:6333"
      QDRANT_COLLECTION: "social-media"
      LANGFUSE_HOST: "http://omni-langfuse:3000"
      LANGFUSE_PUBLIC_KEY: "${LANGFUSE_PUBLIC_KEY}"
      LANGFUSE_SECRET_KEY: "${LANGFUSE_SECRET_KEY}"
      MATTERMOST_WEBHOOK_URL: "${MATTERMOST_GI_WEBHOOK_URL}"
      MATTERMOST_CHANNEL: "omni-generation-intelligence"
      MINIO_ENDPOINT: "omni-minio:9000"
      MINIO_ACCESS_KEY: "${MINIO_ACCESS_KEY}"
      MINIO_SECRET_KEY: "${MINIO_SECRET_KEY}"
      MINIO_BUCKET: "social-media-assets"
      MINIO_SECURE: "false"
      MARKETING_ENGINE_URL: "http://omni-marketing-engine:9640"
      TWITTER_API_KEY: "${TWITTER_API_KEY}"
      TWITTER_API_SECRET: "${TWITTER_API_SECRET}"
      TWITTER_ACCESS_TOKEN: "${TWITTER_ACCESS_TOKEN}"
      TWITTER_ACCESS_SECRET: "${TWITTER_ACCESS_SECRET}"
      LINKEDIN_CLIENT_ID: "${LINKEDIN_CLIENT_ID}"
      LINKEDIN_CLIENT_SECRET: "${LINKEDIN_CLIENT_SECRET}"
      INSTAGRAM_ACCESS_TOKEN: "${INSTAGRAM_ACCESS_TOKEN}"
      YOUTUBE_API_KEY: "${YOUTUBE_API_KEY}"
      TIKTOK_ACCESS_TOKEN: "${TIKTOK_ACCESS_TOKEN}"
      FACEBOOK_PAGE_TOKEN: "${FACEBOOK_PAGE_TOKEN}"
      REDDIT_CLIENT_ID: "${REDDIT_CLIENT_ID}"
      REDDIT_CLIENT_SECRET: "${REDDIT_CLIENT_SECRET}"
      THREADS_ACCESS_TOKEN: "${THREADS_ACCESS_TOKEN}"
      BLUESKY_HANDLE: "${BLUESKY_HANDLE}"
      BLUESKY_APP_PASSWORD: "${BLUESKY_APP_PASSWORD}"
    ports:
      - "9641:9641"
    volumes:
      - social_media_data:/app/data
    networks:
      - omni-quantum-network
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:9641/health')\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=256M
    labels:
      - "omni.quantum.component=social-media"
      - "omni.quantum.tier=generation-intelligence"
      - "omni.quantum.system=39"
      - "omni.quantum.phase=4"
      - "omni.quantum.critical=true"
      - "omni.quantum.port=9641"
      - "prometheus.scrape=true"
      - "prometheus.port=9641"
      - "prometheus.path=/metrics"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "omni.quantum.component"
        tag: "{{.Name}}"
