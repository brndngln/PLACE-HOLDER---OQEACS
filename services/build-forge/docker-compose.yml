version: '3.8'
services:
  woodpecker-server:
    image: woodpeckerci/woodpecker-server:v2.7.1
    container_name: omni-woodpecker-server
    restart: unless-stopped
    env_file:
    - ./config/woodpecker-server.env
    environment:
      WOODPECKER_HOST: http://omni-woodpecker-server:8000
      WOODPECKER_GITEA: 'true'
      WOODPECKER_GITEA_URL: http://omni-gitea:3000
      WOODPECKER_GITEA_CLIENT: ${WOODPECKER_GITEA_CLIENT:-from_vault}
      WOODPECKER_GITEA_SECRET: ${WOODPECKER_GITEA_SECRET:-from_vault}
      WOODPECKER_AGENT_SECRET: ${WOODPECKER_AGENT_SECRET:-from_vault}
      WOODPECKER_DATABASE_DRIVER: postgres
      WOODPECKER_DATABASE_DATASOURCE: postgres://woodpecker:${WOODPECKER_DB_PASSWORD:-password}@omni-postgres:5432/woodpecker?sslmode=disable
      WOODPECKER_ADMIN: brendan
      WOODPECKER_LOG_LEVEL: info
      WOODPECKER_LOG_FORMAT: json
    ports:
      - 8015:8000
    volumes:
      - woodpecker-server-data:/var/lib/woodpecker
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
    healthcheck:
      test:
        - CMD-SHELL
        - wget -qO- http://localhost:8000/healthz || exit 1
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      omni-postgres:
        condition: service_healthy
    labels:
      omni.quantum.component: woodpecker-server
      omni.quantum.tier: development
      omni.quantum.critical: 'true'
    networks:
      - omni-quantum-network
      - omni-quantum-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
  woodpecker-agent-1:
    image: woodpeckerci/woodpecker-agent:v2.7.1
    container_name: omni-woodpecker-agent-1
    restart: unless-stopped
    environment:
      WOODPECKER_SERVER: omni-woodpecker-server:9000
      WOODPECKER_AGENT_SECRET: ${WOODPECKER_AGENT_SECRET:-from_vault}
      WOODPECKER_LOG_LEVEL: info
      WOODPECKER_LOG_FORMAT: json
      WOODPECKER_MAX_PROCS: '2'
      WOODPECKER_HEALTHCHECK: 'true'
      WOODPECKER_BACKEND_DOCKER_NETWORK: omni-quantum-network
      DOCKER_HOST: unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - woodpecker-agent-1-data:/var/lib/woodpecker
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '0.5'
        reservations:
          memory: 512M
    healthcheck:
      test:
        - CMD-SHELL
        - wget -qO- http://localhost:3000/healthz || exit 1
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    depends_on:
      woodpecker-server:
        condition: service_healthy
    labels:
      omni.quantum.component: woodpecker-agent-1
      omni.quantum.tier: development
      omni.quantum.critical: 'false'
    networks:
      - omni-quantum-network
      - omni-quantum-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
  woodpecker-agent-2:
    image: woodpeckerci/woodpecker-agent:v2.7.1
    container_name: omni-woodpecker-agent-2
    restart: unless-stopped
    privileged: true
    environment:
      WOODPECKER_SERVER: omni-woodpecker-server:9000
      WOODPECKER_AGENT_SECRET: ${WOODPECKER_AGENT_SECRET:-from_vault}
      WOODPECKER_LOG_LEVEL: info
      WOODPECKER_LOG_FORMAT: json
      WOODPECKER_MAX_PROCS: '2'
      WOODPECKER_HEALTHCHECK: 'true'
      WOODPECKER_BACKEND_DOCKER_NETWORK: omni-quantum-network
      DOCKER_HOST: tcp://localhost:2376
      DOCKER_TLS_VERIFY: '1'
      DOCKER_CERT_PATH: /certs/client
    volumes:
      - woodpecker-agent-2-data:/var/lib/woodpecker
      - dind-certs-client:/certs/client:ro
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '0.5'
        reservations:
          memory: 512M
    healthcheck:
      test:
        - CMD-SHELL
        - wget -qO- http://localhost:3000/healthz || exit 1
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    depends_on:
      woodpecker-server:
        condition: service_healthy
      dind:
        condition: service_healthy
    labels:
      omni.quantum.component: woodpecker-agent-2
      omni.quantum.tier: development
      omni.quantum.critical: 'false'
    networks:
      - omni-quantum-network
      - omni-quantum-network
    security_opt:
      - no-new-privileges:true
  dind:
    image: docker:26-dind
    container_name: omni-woodpecker-dind
    restart: unless-stopped
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: /certs
    volumes:
      - dind-storage:/var/lib/docker
      - dind-certs-ca:/certs/ca
      - dind-certs-client:/certs/client
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 256M
    healthcheck:
      test:
        - CMD
        - docker
        - info
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 20s
    labels:
      omni.quantum.component: woodpecker-dind
      omni.quantum.tier: development
      omni.quantum.critical: 'false'
    networks:
      - omni-quantum-network
      - omni-quantum-network
    security_opt:
      - no-new-privileges:true
  notifier:
    image: python:3.12-slim
    container_name: omni-build-forge-notifier
    restart: unless-stopped
    working_dir: /app
    command: "sh -c \"\n  pip install --no-cache-dir fastapi uvicorn httpx structlog pydantic &&\n  python -m uvicorn main:app\
      \ --host 0.0.0.0 --port 8001 --log-level info\n\"\n"
    environment:
      SERVICE_PORT: '8001'
      MATTERMOST_WEBHOOK_URL: ${MATTERMOST_WEBHOOK_URL:-http://omni-mattermost-webhook:8066/hooks/builds}
      MATTERMOST_DEPLOY_WEBHOOK_URL: ${MATTERMOST_DEPLOY_WEBHOOK_URL:-http://omni-mattermost-webhook:8066/hooks/deployments}
      OMI_BRIDGE_URL: ${OMI_BRIDGE_URL:-http://omni-omi-bridge:9700}
      WOODPECKER_URL: http://omni-woodpecker-server:8000
      LANGFUSE_URL: http://omni-langfuse:3000
    ports:
      - 8005:8001
    volumes:
      - ./notifier:/app:ro
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
    healthcheck:
      test:
        - CMD-SHELL
        - python -c "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')" || exit 1
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      woodpecker-server:
        condition: service_healthy
    labels:
      omni.quantum.component: build-forge-notifier
      omni.quantum.tier: development
      omni.quantum.critical: 'false'
    networks:
      - omni-quantum-network
      - omni-quantum-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
  omni-postgres:
    image: postgres:16-alpine
    container_name: omni-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: woodpecker
      POSTGRES_USER: woodpecker
      POSTGRES_PASSWORD: ${WOODPECKER_DB_PASSWORD:-password}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '2.0'
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U woodpecker -d woodpecker
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    labels:
      omni.quantum.component: postgres
      omni.quantum.tier: foundation
      omni.quantum.critical: 'true'
    networks:
      - omni-quantum-network
      - omni-quantum-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
volumes:
  woodpecker-server-data:
    driver: local
    labels:
    - omni.quantum.system=build-forge
  woodpecker-agent-1-data:
    driver: local
    labels:
    - omni.quantum.system=build-forge
  woodpecker-agent-2-data:
    driver: local
    labels:
    - omni.quantum.system=build-forge
  dind-storage:
    driver: local
    labels:
    - omni.quantum.system=build-forge
  dind-certs-ca:
    driver: local
    labels:
    - omni.quantum.system=build-forge
  dind-certs-client:
    driver: local
    labels:
    - omni.quantum.system=build-forge
  postgres-data:
    driver: local
    labels:
    - omni.quantum.system=build-forge
networks:
  omni-quantum-network:
    external: true
