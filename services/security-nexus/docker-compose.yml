version: '3.8'
services:
  omni-authentik-db:
    image: postgres:16-alpine
    container_name: omni-authentik-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${AUTHENTIK_POSTGRESQL_USER:-authentik}
      POSTGRES_PASSWORD: ${AUTHENTIK_POSTGRESQL_PASSWORD}
      POSTGRES_DB: ${AUTHENTIK_POSTGRESQL_DB:-authentik}
    volumes:
      - authentik-db-data:/var/lib/postgresql/data
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U ${AUTHENTIK_POSTGRESQL_USER:-authentik} -d ${AUTHENTIK_POSTGRESQL_DB:-authentik}
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '2.0'
    labels:
      omni.quantum.component: authentik-db
      omni.quantum.tier: security
      omni.quantum.critical: 'true'
    networks:
      - omni-quantum-network
      - omni-quantum-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
  omni-authentik-redis:
    image: redis:7-alpine
    container_name: omni-authentik-redis
    restart: unless-stopped
    command: 'redis-server --requirepass ${AUTHENTIK_REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru --save
      60 1000

      '
    volumes:
      - authentik-redis-data:/data
    healthcheck:
      test:
        - CMD
        - redis-cli
        - -a
        - ${AUTHENTIK_REDIS_PASSWORD}
        - ping
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '2.0'
    labels:
      omni.quantum.component: authentik-redis
      omni.quantum.tier: security
      omni.quantum.critical: 'true'
    networks:
      - omni-quantum-network
      - omni-quantum-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
  omni-authentik:
    image: ghcr.io/goauthentik/server:2024.2
    container_name: omni-authentik
    restart: unless-stopped
    command: server
    environment:
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
      AUTHENTIK_POSTGRESQL__HOST: omni-authentik-db
      AUTHENTIK_POSTGRESQL__PORT: '5432'
      AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_POSTGRESQL_USER:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_POSTGRESQL_PASSWORD}
      AUTHENTIK_POSTGRESQL__NAME: ${AUTHENTIK_POSTGRESQL_DB:-authentik}
      AUTHENTIK_REDIS__HOST: omni-authentik-redis
      AUTHENTIK_REDIS__PORT: '6379'
      AUTHENTIK_REDIS__PASSWORD: ${AUTHENTIK_REDIS_PASSWORD}
      AUTHENTIK_REDIS__DB: '0'
      AUTHENTIK_EMAIL__HOST: ${AUTHENTIK_EMAIL_HOST:-localhost}
      AUTHENTIK_EMAIL__PORT: ${AUTHENTIK_EMAIL_PORT:-587}
      AUTHENTIK_EMAIL__USERNAME: ${AUTHENTIK_EMAIL_USERNAME:-}
      AUTHENTIK_EMAIL__PASSWORD: ${AUTHENTIK_EMAIL_PASSWORD:-}
      AUTHENTIK_EMAIL__USE_TLS: ${AUTHENTIK_EMAIL_USE_TLS:-true}
      AUTHENTIK_EMAIL__FROM: ${AUTHENTIK_EMAIL_FROM:-noreply@omni-quantum.internal}
      AUTHENTIK_LOG_LEVEL: info
      AUTHENTIK_ERROR_REPORTING__ENABLED: 'false'
      AUTHENTIK_BOOTSTRAP_PASSWORD: ${AUTHENTIK_BOOTSTRAP_PASSWORD}
      AUTHENTIK_BOOTSTRAP_TOKEN: ${AUTHENTIK_BOOTSTRAP_TOKEN}
      AUTHENTIK_BOOTSTRAP_EMAIL: ${AUTHENTIK_BOOTSTRAP_EMAIL:-admin@omni-quantum.internal}
    volumes:
      - authentik-media:/media
      - authentik-templates:/templates
    ports:
      - 9000:9000
      - 9443:9443
    healthcheck:
      test:
        - CMD
        - curl
        - -sf
        - http://localhost:9000/-/health/live/
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
    labels:
      traefik.enable: 'true'
      traefik.http.routers.authentik.rule: Host(`auth.omni-quantum.internal`)
      traefik.http.routers.authentik.entrypoints: websecure
      traefik.http.routers.authentik.tls: 'true'
      traefik.http.services.authentik.loadbalancer.server.port: '9000'
      omni.quantum.component: authentik
      omni.quantum.tier: security
      omni.quantum.critical: 'true'
    depends_on:
      omni-authentik-db:
        condition: service_healthy
      omni-authentik-redis:
        condition: service_healthy
    networks:
      - omni-quantum-network
      - omni-quantum-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
  omni-authentik-worker:
    image: ghcr.io/goauthentik/server:2024.2
    container_name: omni-authentik-worker
    restart: unless-stopped
    command: worker
    environment:
      AUTHENTIK_SECRET_KEY: ${AUTHENTIK_SECRET_KEY}
      AUTHENTIK_POSTGRESQL__HOST: omni-authentik-db
      AUTHENTIK_POSTGRESQL__PORT: '5432'
      AUTHENTIK_POSTGRESQL__USER: ${AUTHENTIK_POSTGRESQL_USER:-authentik}
      AUTHENTIK_POSTGRESQL__PASSWORD: ${AUTHENTIK_POSTGRESQL_PASSWORD}
      AUTHENTIK_POSTGRESQL__NAME: ${AUTHENTIK_POSTGRESQL_DB:-authentik}
      AUTHENTIK_REDIS__HOST: omni-authentik-redis
      AUTHENTIK_REDIS__PORT: '6379'
      AUTHENTIK_REDIS__PASSWORD: ${AUTHENTIK_REDIS_PASSWORD}
      AUTHENTIK_REDIS__DB: '0'
      AUTHENTIK_LOG_LEVEL: info
      AUTHENTIK_ERROR_REPORTING__ENABLED: 'false'
    volumes:
      - authentik-media:/media
      - authentik-templates:/templates
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
    labels:
      omni.quantum.component: authentik-worker
      omni.quantum.tier: security
      omni.quantum.critical: 'true'
    depends_on:
      omni-authentik-db:
        condition: service_healthy
      omni-authentik-redis:
        condition: service_healthy
    networks:
      - omni-quantum-network
      - omni-quantum-network
    healthcheck:
      test:
        - CMD-SHELL
        - exit 0
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
volumes:
  authentik-db-data:
    driver: local
  authentik-redis-data:
    driver: local
  authentik-media:
    driver: local
  authentik-templates:
    driver: local
networks:
  omni-quantum-network:
    external: true
