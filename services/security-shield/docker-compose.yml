version: '3.8'
services:
  omni-crowdsec:
    image: crowdsecurity/crowdsec:v1.6
    container_name: omni-crowdsec
    restart: unless-stopped
    environment:
      ENROLL_KEY: ${CROWDSEC_ENROLL_KEY:-}
      ENROLL_INSTANCE_NAME: omni-quantum-elite
      ENROLL_TAGS: omni-quantum,production
      COLLECTIONS: crowdsecurity/linux crowdsecurity/traefik crowdsecurity/http-cve crowdsecurity/base-http-scenarios crowdsecurity/whitelist-good-actors
      CUSTOM_HOSTNAME: omni-crowdsec
      LEVEL_INFO: 'true'
    volumes:
    - ./config/acquis.yaml:/etc/crowdsec/acquis.yaml:ro
    - ./config/scenarios:/etc/crowdsec/scenarios:ro
    - ./config/notifications:/etc/crowdsec/notifications:ro
    - ./config/whitelist.yaml:/etc/crowdsec/parsers/s02-enrich/omni-whitelist.yaml:ro
    - crowdsec-data:/var/lib/crowdsec/data
    - crowdsec-config:/etc/crowdsec
    - traefik-logs:/var/log/traefik:ro
    - /var/log:/var/log/host:ro
    - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
    - 8180:8080
    - 6060:6060
    healthcheck:
      test:
      - CMD
      - cscli
      - version
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
    labels:
      omni.quantum.component: crowdsec
      omni.quantum.tier: development
      omni.quantum.critical: 'false'
    networks:
    - omni-quantum-network
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
  omni-crowdsec-bouncer:
    image: fbonalair/traefik-crowdsec-bouncer:v0.6.4
    container_name: omni-crowdsec-bouncer
    restart: unless-stopped
    environment:
      CROWDSEC_BOUNCER_API_KEY: ${CROWDSEC_BOUNCER_API_KEY}
      CROWDSEC_AGENT_HOST: omni-crowdsec:8080
      CROWDSEC_BOUNCER_SCHEME: http
      GIN_MODE: release
      CROWDSEC_BOUNCER_BAN_TEMPLATE_PATH: /etc/crowdsec-bouncer/ban.html
    ports:
    - 8078:8080
    healthcheck:
      test:
      - CMD
      - wget
      - --spider
      - -q
      - http://localhost:8080/api/v1/ping
      interval: 15s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.5'
    labels:
      traefik.enable: 'true'
      traefik.http.middlewares.crowdsec.forwardauth.address: http://omni-crowdsec-bouncer:8080/api/v1/forwardAuth
      traefik.http.middlewares.crowdsec.forwardauth.trustForwardHeader: 'true'
      omni.quantum.component: crowdsec-bouncer
      omni.quantum.tier: development
      omni.quantum.critical: 'false'
    depends_on:
      omni-crowdsec:
        condition: service_healthy
    networks:
    - omni-quantum-network
    security_opt:
    - no-new-privileges:true
volumes:
  crowdsec-data:
    driver: local
  crowdsec-config:
    driver: local
  traefik-logs:
    external: true
networks:
  omni-quantum-network:
    external: true
