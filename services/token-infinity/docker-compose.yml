version: '3.8'
services:
  omni-context-manager:
    build:
      context: .
      dockerfile: context-manager/Dockerfile
    container_name: omni-context-manager
    restart: unless-stopped
    ports:
    - 9600:9600
    environment:
      QDRANT_URL: ${QDRANT_URL:-http://omni-qdrant:6333}
      LITELLM_URL: ${LITELLM_URL:-http://omni-litellm:4000}
      OLLAMA_MANAGER_URL: ${OLLAMA_MANAGER_URL:-http://omni-model-manager:11435}
      LANGFUSE_URL: ${LANGFUSE_URL:-http://omni-langfuse:3000}
      VAULT_URL: ${VAULT_URL:-http://omni-vault:8200}
      GITEA_URL: ${GITEA_URL:-http://omni-gitea:3000}
      MATTERMOST_WEBHOOK_URL: ${MATTERMOST_WEBHOOK_URL:-http://omni-mattermost-webhook:8066}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
    - ./config/provider-registry.yaml:/app/config/provider-registry.yaml:ro
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
    healthcheck:
      test:
      - CMD
      - curl
      - -sf
      - http://localhost:9600/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: '5'
    labels:
      traefik.enable: 'true'
      traefik.http.routers.context-manager.rule: Host(`context.omni-quantum.internal`)
      traefik.http.routers.context-manager.entrypoints: websecure
      traefik.http.routers.context-manager.tls: 'true'
      traefik.http.services.context-manager.loadbalancer.server.port: '9600'
      omni.quantum.component: context-manager
      omni.quantum.tier: business
      omni.quantum.critical: 'false'
    networks:
    - omni-quantum-network
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
  omni-provider-router:
    build:
      context: .
      dockerfile: provider-router/Dockerfile
    container_name: omni-provider-router
    restart: unless-stopped
    ports:
    - 9601:9601
    environment:
      QDRANT_URL: ${QDRANT_URL:-http://omni-qdrant:6333}
      LITELLM_URL: ${LITELLM_URL:-http://omni-litellm:4000}
      OLLAMA_MANAGER_URL: ${OLLAMA_MANAGER_URL:-http://omni-model-manager:11435}
      LANGFUSE_URL: ${LANGFUSE_URL:-http://omni-langfuse:3000}
      VAULT_URL: ${VAULT_URL:-http://omni-vault:8200}
      MATTERMOST_WEBHOOK_URL: ${MATTERMOST_WEBHOOK_URL:-http://omni-mattermost-webhook:8066}
      PROVIDER_REGISTRY_PATH: /app/config/provider-registry.yaml
      LOG_FORMAT: ${LOG_FORMAT:-json}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
    - ./config/provider-registry.yaml:/app/config/provider-registry.yaml:ro
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
    healthcheck:
      test:
      - CMD
      - curl
      - -sf
      - http://localhost:9601/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: '5'
    labels:
      traefik.enable: 'true'
      traefik.http.routers.provider-router.rule: Host(`router.omni-quantum.internal`)
      traefik.http.routers.provider-router.entrypoints: websecure
      traefik.http.routers.provider-router.tls: 'true'
      traefik.http.services.provider-router.loadbalancer.server.port: '9601'
      omni.quantum.component: provider-router
      omni.quantum.tier: business
      omni.quantum.critical: 'false'
    networks:
    - omni-quantum-network
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
networks:
  omni-quantum-network:
    external: true
