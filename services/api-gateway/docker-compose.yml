version: '3.9'
x-logging:
  driver: json-file
  options:
    max-size: 50m
    max-file: '5'
x-labels:
  omni.quantum.tier: standard
  omni.quantum.critical: 'false'
services:
  kong:
    image: kong:3.8
    container_name: omni-kong
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: omni-kong-postgres
      KONG_PG_DATABASE: kong
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: ${KONG_PG_PASSWORD}
      KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 ssl
      KONG_ADMIN_LISTEN: 0.0.0.0:8001, 0.0.0.0:8444 ssl
      KONG_STATUS_LISTEN: 0.0.0.0:8100
      KONG_NGINX_WORKER_PROCESSES: auto
      KONG_LOG_LEVEL: info
      KONG_PLUGINS: bundled,prometheus
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
    ports:
    - 8001:8000
    - 8444:8444
    depends_on:
      kong-postgres:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - curl
      - -fsS
      - http://localhost:8100/status
      interval: 20s
      timeout: 10s
      retries: 6
      start_period: 40s
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: '5'
    labels:
      omni.quantum.component: kong
      omni.quantum.tier: business
      omni.quantum.critical: 'false'
    volumes:
    - kong-prefix:/kong_prefix/
    - kong-tmp:/tmp
    - ./developer-portal:/developer-portal:ro
    networks:
      - omni-quantum-network
    - omni-quantum-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
  kong-postgres:
    image: postgres:16-alpine
    container_name: omni-kong-postgres
    environment:
      POSTGRES_DB: kong
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: ${KONG_PG_PASSWORD}
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U kong -d kong
      interval: 15s
      timeout: 5s
      retries: 6
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: '5'
    labels:
      omni.quantum.component: kong-postgres
      omni.quantum.tier: business
      omni.quantum.critical: 'false'
    volumes:
    - kong-postgres-data:/var/lib/postgresql/data
    networks:
      - omni-quantum-network
    - omni-quantum-network
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
volumes:
  kong-prefix: null
  kong-tmp: null
  kong-postgres-data: null
networks:
  omni-quantum-network:
    external: true
