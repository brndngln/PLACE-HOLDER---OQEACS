version: '3.8'
services:
  omni-litellm:
    image: litellm/litellm:v1.56.0
    container_name: omni-litellm
    restart: unless-stopped
    command:
    - --config
    - /app/config/litellm-config.yaml
    - --port
    - '4000'
    - --num_workers
    - '4'
    ports:
    - 4000:4000
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY}
      DATABASE_URL: ${LITELLM_DATABASE_URL}
      REDIS_URL: ${REDIS_URL:-redis://omni-redis:6379/2}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY}
      LANGFUSE_HOST: ${LANGFUSE_HOST:-http://omni-langfuse:3000}
      MATTERMOST_WEBHOOK_URL: ${MATTERMOST_WEBHOOK_URL}
      LITELLM_LOG: INFO
      STORE_MODEL_IN_DB: 'True'
    volumes:
    - ./config/litellm-config.yaml:/app/config/litellm-config.yaml:ro
    - ./middleware/request-logger.py:/app/middleware/request-logger.py:ro
    healthcheck:
      test:
      - CMD
      - curl
      - -sf
      - http://localhost:4000/health/liveliness
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2.0'
        reservations:
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: '5'
    labels:
      traefik.enable: 'true'
      traefik.http.routers.litellm.rule: Host(`ai.omni-quantum.internal`)
      traefik.http.routers.litellm.entrypoints: websecure
      traefik.http.routers.litellm.tls: 'true'
      traefik.http.services.litellm.loadbalancer.server.port: '4000'
      omni.quantum.component: litellm
      omni.quantum.tier: foundation
      omni.quantum.critical: 'true'
    networks:
      - omni-quantum-network
    - omni-quantum-network
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
  omni-cost-tracker:
    build:
      context: ./cost-tracker
      dockerfile: Dockerfile
    container_name: omni-cost-tracker
    restart: unless-stopped
    ports:
    - 4001:4001
    environment:
      LANGFUSE_HOST: ${LANGFUSE_HOST:-http://omni-langfuse:3000}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY}
      MATTERMOST_WEBHOOK_URL: ${MATTERMOST_WEBHOOK_URL}
      MONTHLY_BUDGET_USD: ${MONTHLY_BUDGET_USD:-500.0}
      DAILY_BUDGET_USD: ${DAILY_BUDGET_USD:-25.0}
      LOG_FORMAT: ${LOG_FORMAT:-json}
    healthcheck:
      test:
      - CMD
      - curl
      - -sf
      - http://localhost:4001/health
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '1.0'
        reservations:
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: '5'
    labels:
      traefik.enable: 'true'
      traefik.http.routers.cost-tracker.rule: Host(`costs.omni-quantum.internal`)
      traefik.http.routers.cost-tracker.entrypoints: websecure
      traefik.http.routers.cost-tracker.tls: 'true'
      traefik.http.services.cost-tracker.loadbalancer.server.port: '4001'
      omni.quantum.component: cost-tracker
      omni.quantum.tier: business
      omni.quantum.critical: 'false'
    depends_on:
      omni-litellm:
        condition: service_healthy
    networks:
      - omni-quantum-network
    - omni-quantum-network
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
networks:
  omni-quantum-network:
    external: true
