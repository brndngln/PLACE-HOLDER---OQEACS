version: "3.9"

networks:
  omni-quantum-network:
    external: true

volumes:
  api_knowledge_data:
    driver: local

services:
  api-knowledge:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_DATE: "${BUILD_DATE:-2026-02-11T00:00:00Z}"
        VERSION: "${VERSION:-1.0.0}"
    image: omni-api-knowledge:${VERSION:-1.0.0}
    container_name: omni-api-knowledge
    hostname: omni-api-knowledge
    env_file:
      - ../../.env
    environment:
      SERVICE_NAME: "api-knowledge"
      SERVICE_PORT: "9626"
      VERSION: "${VERSION:-1.0.0}"
      LOG_LEVEL: "${LOG_LEVEL:-info}"
      LOG_FORMAT: "json"
      DATABASE_URL: "postgresql+asyncpg://${GI_DB_USER:-omni}:${GI_DB_PASSWORD}@omni-gi-postgres:5432/api_knowledge_db"
      REDIS_URL: "redis://:${REDIS_PASSWORD}@omni-redis:6379/0"
      LITELLM_URL: "http://omni-litellm:4000"
      LITELLM_API_KEY: "${LITELLM_API_KEY}"
      QDRANT_URL: "http://omni-qdrant:6333"
      QDRANT_COLLECTION: "api-knowledge"
      LANGFUSE_HOST: "http://omni-langfuse:3000"
      LANGFUSE_PUBLIC_KEY: "${LANGFUSE_PUBLIC_KEY}"
      LANGFUSE_SECRET_KEY: "${LANGFUSE_SECRET_KEY}"
      MATTERMOST_WEBHOOK_URL: "${MATTERMOST_GI_WEBHOOK_URL}"
      MATTERMOST_CHANNEL: "omni-generation-intelligence"
      MINIO_ENDPOINT: "omni-minio:9000"
      MINIO_ACCESS_KEY: "${MINIO_ACCESS_KEY}"
      MINIO_SECRET_KEY: "${MINIO_SECRET_KEY}"
      MINIO_BUCKET: "gi-api-knowledge"
      MINIO_SECURE: "false"
      GITEA_URL: "http://omni-gitea:3000"
      GITEA_TOKEN: "${GITEA_TOKEN}"
    ports:
      - "9626:9626"
    volumes:
      - api_knowledge_data:/app/data
    networks:
      - omni-quantum-network
    healthcheck:
      test: ['CMD-SHELL', 'python -c "import urllib.request; urllib.request.urlopen(\"http://localhost:9626/health\")"']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=256M
    labels:
      - "omni.quantum.component=api-knowledge"
      - "omni.quantum.tier=generation-intelligence"
      - "omni.quantum.system=10"
      - "omni.quantum.phase=3"
      - "omni.quantum.critical=false"
      - "omni.quantum.port=9626"
      - "prometheus.scrape=true"
      - "prometheus.port=9626"
      - "prometheus.path=/metrics"
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "omni.quantum.component"
        tag: "{{.Name}}"
