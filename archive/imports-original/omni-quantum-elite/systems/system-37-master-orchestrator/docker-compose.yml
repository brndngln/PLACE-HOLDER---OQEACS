###############################################################################
# SYSTEM 37 — OMNI COMMAND: Master Orchestrator
# The Capstone — Unified control plane for all 36 systems
#
# Services:
#   1. omni-orchestrator    — Core API: status, deploy, backup, health, logs
#   2. omni-dashboard       — Web UI: real-time dashboard for all systems
#   3. omni-mattermost-bot  — Chat ops: control platform via Mattermost
#   4. omni-omi-bridge      — Voice-first control via Omi wearable
#   5. omni-event-bus       — Internal event streaming (Redis Streams)
###############################################################################

x-logging: &logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "5"
    tag: "{{.Name}}"

x-labels: &base-labels
  omni.quantum.system: "37"
  omni.quantum.component: "master-orchestrator"
  omni.quantum.tier: "critical"

networks:
  omni-quantum-network:
    external: true

volumes:
  orchestrator-data:
    name: omni-orchestrator-data

services:
  # =========================================================================
  # Core Orchestrator API
  # =========================================================================
  omni-orchestrator:
    build:
      context: ./config/orchestrator
      dockerfile: Dockerfile
    container_name: omni-orchestrator
    restart: unless-stopped
    logging: *logging
    labels:
      <<: *base-labels
      omni.quantum.critical: "true"
      omni.quantum.description: "Master Orchestrator API — unified control plane"
    ports:
      - "9500:9500"
    environment:
      # --- Core ---
      ORCHESTRATOR_PORT: "9500"
      ORCHESTRATOR_HOST: "0.0.0.0"
      LOG_LEVEL: "INFO"

      # --- PostgreSQL ---
      DATABASE_URL: "postgresql://omni_orchestrator:${ORCHESTRATOR_DB_PASSWORD:-orchestrator_secret}@omni-postgres:5432/omni_orchestrator"

      # --- Redis (event bus) ---
      REDIS_URL: "redis://omni-redis:6379/5"

      # --- Service Endpoints (all 36 systems) ---
      # System 1: Backup Fortress
      BACKUP_URL: "http://omni-restic-server:8000"
      # System 2: Cryptographic Fortress (Vault)
      VAULT_URL: "http://omni-vault:8200"
      VAULT_TOKEN: "${VAULT_ROOT_TOKEN:-}"
      # System 3: AI Gateway (LiteLLM)
      LITELLM_URL: "http://omni-litellm:4000"
      # System 4: Security Nexus (Authentik)
      AUTHENTIK_URL: "http://omni-authentik:9000"
      # System 5: Observatory (Prometheus + Grafana)
      PROMETHEUS_URL: "http://omni-prometheus:9090"
      GRAFANA_URL: "http://omni-grafana:3000"
      # System 6: Log Nexus (Loki)
      LOKI_URL: "http://omni-loki:3100"
      # System 7: Code Fortress (Gitea)
      GITEA_URL: "http://omni-gitea:3000"
      GITEA_TOKEN: "${GITEA_ADMIN_TOKEN:-}"
      # System 8: Neural Network (Ollama)
      OLLAMA_URL: "http://omni-ollama:11434"
      # System 9: Workflow Engine (n8n)
      N8N_URL: "http://omni-n8n:5678"
      # System 10: Communication Hub (Mattermost)
      MATTERMOST_URL: "http://omni-mattermost:8065"
      MATTERMOST_TOKEN: "${MATTERMOST_BOT_TOKEN:-}"
      MATTERMOST_WEBHOOK: "${MATTERMOST_WEBHOOK_URL:-}"
      # System 11: Vector Memory (Qdrant)
      QDRANT_URL: "http://omni-qdrant:6333"
      # System 12: Object Store (MinIO)
      MINIO_URL: "http://omni-minio:9000"
      # System 13: AI Observability (Langfuse)
      LANGFUSE_URL: "http://omni-langfuse:3000"
      # System 14: Project Command (Plane)
      PLANE_URL: "http://omni-plane-web:3000"
      # System 15: Integration Hub (Nango)
      NANGO_URL: "http://omni-nango:3003"
      # System 16: AI Coder Alpha (OpenHands)
      OPENHANDS_URL: "http://omni-openhands:3000"
      # System 17: AI Coder Beta (SWE-Agent)
      SWEAGENT_URL: "http://omni-swe-agent:8000"
      # System 18: Deploy Engine (Coolify)
      COOLIFY_URL: "http://omni-coolify:8000"
      # System 19: Flow Builder (Flowise)
      FLOWISE_URL: "http://omni-flowise:3000"
      # System 20: Knowledge Base (Wiki.js)
      WIKIJS_URL: "http://omni-wikijs:3000"
      # System 21: Analytics Engine (Superset)
      SUPERSET_URL: "http://omni-superset:8088"
      # System 22: Schedule Manager (Cal.com)
      CALCOM_URL: "http://omni-calcom:3000"
      # System 23: CRM Hub (Twenty)
      TWENTY_URL: "http://omni-twenty:3000"
      # System 24: Invoice Manager (Crater)
      CRATER_URL: "http://omni-crater:80"
      # System 25: Security Shield (CrowdSec)
      CROWDSEC_URL: "http://omni-crowdsec:8080"
      # System 26: Container Manager (Portainer)
      PORTAINER_URL: "http://omni-portainer:9000"
      # System 27: Token Infinity
      TOKEN_INFINITY_URL: "http://omni-token-infinity:9600"
      # System 28: Omi Wearable Bridge
      OMI_BRIDGE_URL: "http://omni-omi-bridge:9700"
      OMI_WEBHOOK: "${OMI_WEBHOOK_URL:-}"
      # System 29: Enhanced Monitoring
      THANOS_URL: "http://omni-thanos-query:9090"
      ANOMALY_DETECTOR_URL: "http://omni-anomaly-detector:9291"
      SLA_TRACKER_URL: "http://omni-sla-tracker:9292"
      CAPACITY_PLANNER_URL: "http://omni-capacity-planner:9293"
      # System 30: Enhanced Logging
      LOG_PATTERN_DETECTOR_URL: "http://omni-log-pattern-detector:9301"
      LOG_CORRELATOR_URL: "http://omni-log-correlator:9302"
      # System 31: Uptime Monitor
      UPTIME_KUMA_URL: "http://omni-uptime-kuma:3001"
      # System 32: Enhanced Backup
      BACKUP_ORCHESTRATOR_URL: "http://omni-backup-orchestrator:9321"
      BACKUP_VERIFIER_URL: "http://omni-backup-verifier:9322"
      # System 33: Enhanced Secrets
      ROTATION_AGENT_URL: "http://omni-secret-rotation:9331"
      # System 34: Enhanced Proxy
      TRAEFIK_URL: "http://omni-traefik:8080"
      # System 35: CI/CD Pipelines
      WOODPECKER_URL: "http://omni-woodpecker-server:8000"
      # System 36: Dev Environments
      CODER_URL: "http://omni-coder:7080"
    volumes:
      - orchestrator-data:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - omni-quantum-network
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:9500/health').raise_for_status()"]
      interval: 15s
      timeout: 5s
      retries: 5

  # =========================================================================
  # Web Dashboard — Real-time unified UI
  # =========================================================================
  omni-dashboard:
    build:
      context: ./config/dashboard
      dockerfile: Dockerfile
    container_name: omni-dashboard
    restart: unless-stopped
    logging: *logging
    labels:
      <<: *base-labels
      omni.quantum.description: "Master Dashboard — unified web UI"
    ports:
      - "9501:9501"
    environment:
      ORCHESTRATOR_URL: "http://omni-orchestrator:9500"
      DASHBOARD_PORT: "9501"
    networks:
      - omni-quantum-network
    depends_on:
      omni-orchestrator:
        condition: service_healthy

  # =========================================================================
  # Mattermost Bot — Chat-based control
  # =========================================================================
  omni-mattermost-bot:
    build:
      context: ./config/mattermost-bot
      dockerfile: Dockerfile
    container_name: omni-mattermost-bot
    restart: unless-stopped
    logging: *logging
    labels:
      <<: *base-labels
      omni.quantum.description: "Mattermost ChatOps bot"
    environment:
      ORCHESTRATOR_URL: "http://omni-orchestrator:9500"
      MATTERMOST_URL: "http://omni-mattermost:8065"
      MATTERMOST_TOKEN: "${MATTERMOST_BOT_TOKEN:-}"
      BOT_CHANNEL: "omni-control"
    networks:
      - omni-quantum-network
    depends_on:
      omni-orchestrator:
        condition: service_healthy

  # =========================================================================
  # Omi Voice Bridge — Voice-first platform control
  # =========================================================================
  omni-voice-bridge:
    build:
      context: ./config/voice-bridge
      dockerfile: Dockerfile
    container_name: omni-voice-bridge
    restart: unless-stopped
    logging: *logging
    labels:
      <<: *base-labels
      omni.quantum.description: "Omi wearable voice-first control bridge"
    ports:
      - "9502:9502"
    environment:
      ORCHESTRATOR_URL: "http://omni-orchestrator:9500"
      LITELLM_URL: "http://omni-litellm:4000"
      OMI_WEBHOOK: "${OMI_WEBHOOK_URL:-}"
      VOICE_BRIDGE_PORT: "9502"
    networks:
      - omni-quantum-network
    depends_on:
      omni-orchestrator:
        condition: service_healthy

  # =========================================================================
  # Event Bus Consumer — Processes platform events
  # =========================================================================
  omni-event-processor:
    build:
      context: ./config/event-processor
      dockerfile: Dockerfile
    container_name: omni-event-processor
    restart: unless-stopped
    logging: *logging
    labels:
      <<: *base-labels
      omni.quantum.description: "Event stream processor"
    environment:
      REDIS_URL: "redis://omni-redis:6379/5"
      ORCHESTRATOR_URL: "http://omni-orchestrator:9500"
      MATTERMOST_WEBHOOK: "${MATTERMOST_WEBHOOK_URL:-}"
      OMI_WEBHOOK: "${OMI_WEBHOOK_URL:-}"
    networks:
      - omni-quantum-network
    depends_on:
      omni-orchestrator:
        condition: service_healthy
