x-logging:
  driver: json-file
  options:
    max-size: 10m
    max-file: '5'
    tag: '{{.Name}}'
services:
  traefik:
    image: traefik:v3.2
    container_name: omni-traefik
    command:
    - --api.dashboard=true
    - --api.insecure=true
    - --providers.docker=true
    - --providers.docker.network=omni-quantum-network
    - --providers.docker.exposedbydefault=false
    - --providers.file.directory=/etc/traefik/dynamic
    - --providers.file.watch=true
    - --entrypoints.web.address=:80
    - --entrypoints.websecure.address=:443
    - --entrypoints.web.http.redirections.entrypoint.to=websecure
    - --entrypoints.web.http.redirections.entrypoint.scheme=https
    - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}
    - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
    - --certificatesresolvers.letsencrypt.acme.tlschallenge=true
    - --metrics.prometheus=true
    - --metrics.prometheus.entrypoint=metrics
    - --entrypoints.metrics.address=:8899
    - --accesslog=true
    - --accesslog.format=json
    - --log.level=INFO
    - --ping=true
    ports:
    - 80:80
    - 443:443
    - 8080:8080
    - 8899:8899
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - traefik-letsencrypt:/letsencrypt
    - ./config/traefik/dynamic:/etc/traefik/dynamic:ro
    - ./config/traefik/certs:/certs:ro
    environment:
      TZ: UTC
    healthcheck:
      test:
      - CMD
      - traefik
      - healthcheck
      - --ping
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'
        tag: '{{.Name}}'
    networks:
    - omni-quantum-network
    labels:
      prometheus.scrape: 'true'
      prometheus.port: '8899'
      omni.quantum.component: traefik
      omni.quantum.tier: business
      omni.quantum.critical: 'true'
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    security_opt:
    - no-new-privileges:true
  rate-limit-manager:
    build:
      context: ./config/rate-limit-manager
      dockerfile: Dockerfile
    container_name: omni-rate-limit-manager
    environment:
      TZ: UTC
      REDIS_URL: redis://omni-redis:6379/7
      MATTERMOST_WEBHOOK: ${MATTERMOST_SECURITY_WEBHOOK}
    ports:
    - 8192:8192
    healthcheck:
      test:
      - CMD
      - python
      - -c
      - import urllib.request; urllib.request.urlopen('http://localhost:8192/health')
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: '5'
        tag: '{{.Name}}'
    networks:
    - omni-quantum-network
    labels:
      prometheus.scrape: 'true'
      prometheus.port: '8192'
      omni.quantum.component: rate-limit-manager
      omni.quantum.tier: business
      omni.quantum.critical: 'false'
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    security_opt:
    - no-new-privileges:true
    cap_drop:
    - ALL
volumes:
  traefik-letsencrypt:
    driver: local
networks:
  omni-quantum-network:
    external: true
