version: "3.9"
x-log: &log {driver: json-file, options: {max-size: "50m", max-file: "5"}}
x-labels: &labels {omni.quantum.tier: standard, omni.quantum.critical: "false"}

services:
  unleash:
    image: unleashorg/unleash-server:latest
    container_name: omni-unleash
    ports: ["4242:4242"]
    environment:
      DATABASE_URL: postgres://{{ vault://secret/data/unleash#db_user }}:{{ vault://secret/data/unleash#db_password }}@omni-unleash-postgres:5432/unleash
      DATABASE_SSL: "false"
      INIT_ADMIN_API_TOKENS: "{{ vault://secret/data/unleash#admin_token }}"
      UNLEASH_URL: http://omni-unleash:4242
    healthcheck: {test: ["CMD", "wget", "-qO-", "http://localhost:4242/health"], interval: 20s, timeout: 10s, retries: 5}
    mem_limit: 256m
    restart: unless-stopped
    logging: *log
    labels: {<<: *labels, omni.quantum.component: unleash}
    depends_on: {unleash-postgres: {condition: service_healthy}}
    networks: [omni-quantum-network]

  unleash-postgres:
    image: postgres:16-alpine
    container_name: omni-unleash-postgres
    environment: {POSTGRES_DB: unleash, POSTGRES_USER: "{{ vault://secret/data/unleash#db_user }}", POSTGRES_PASSWORD: "{{ vault://secret/data/unleash#db_password }}"}
    healthcheck: {test: ["CMD-SHELL", "pg_isready -U {{ vault://secret/data/unleash#db_user }} -d unleash"], interval: 15s, timeout: 5s, retries: 5}
    mem_limit: 256m
    restart: unless-stopped
    logging: *log
    labels: {<<: *labels, omni.quantum.component: unleash-postgres}
    volumes: [unleash-postgres-data:/var/lib/postgresql/data]
    networks: [omni-quantum-network]

volumes: {unleash-postgres-data: {}}
networks: {omni-quantum-network: {external: true}}
