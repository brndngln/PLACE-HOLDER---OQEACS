version: "3.9"

x-log: &log {driver: json-file, options: {max-size: "50m", max-file: "5"}}
x-labels: &labels {omni.quantum.tier: standard, omni.quantum.critical: "false"}

services:
  plausible:
    image: plausible/analytics:latest
    container_name: omni-plausible
    depends_on:
      plausible-postgres: {condition: service_healthy}
      plausible-clickhouse: {condition: service_healthy}
    ports: ["8000:8000"]
    environment:
      BASE_URL: https://plausible.omni.local
      SECRET_KEY_BASE: "{{ vault://secret/data/plausible#secret_key_base }}"
      DATABASE_URL: postgresql://{{ vault://secret/data/plausible#db_user }}:{{ vault://secret/data/plausible#db_password }}@omni-plausible-postgres:5432/plausible
      CLICKHOUSE_DATABASE_URL: http://omni-plausible-clickhouse:8123/plausible_events_db
      DISABLE_REGISTRATION: "true"
      MAILER_EMAIL: notifications@omni.local
    healthcheck: {test: ["CMD", "wget", "-qO-", "http://localhost:8000/api/health"], interval: 20s, timeout: 10s, retries: 5}
    mem_limit: 512m
    restart: unless-stopped
    logging: *log
    labels: {<<: *labels, omni.quantum.component: plausible}
    volumes: [plausible-data:/var/lib/plausible]
    networks: [omni-quantum-network]

  plausible-clickhouse:
    image: clickhouse/clickhouse-server:24
    container_name: omni-plausible-clickhouse
    healthcheck: {test: ["CMD", "clickhouse-client", "--query", "SELECT 1"], interval: 20s, timeout: 10s, retries: 5}
    mem_limit: 1g
    restart: unless-stopped
    logging: *log
    labels: {<<: *labels, omni.quantum.component: plausible-clickhouse}
    volumes: [plausible-clickhouse-data:/var/lib/clickhouse]
    networks: [omni-quantum-network]

  plausible-postgres:
    image: postgres:16-alpine
    container_name: omni-plausible-postgres
    environment:
      POSTGRES_DB: plausible
      POSTGRES_USER: "{{ vault://secret/data/plausible#db_user }}"
      POSTGRES_PASSWORD: "{{ vault://secret/data/plausible#db_password }}"
    healthcheck: {test: ["CMD-SHELL", "pg_isready -U {{ vault://secret/data/plausible#db_user }} -d plausible"], interval: 15s, timeout: 5s, retries: 5}
    mem_limit: 256m
    restart: unless-stopped
    logging: *log
    labels: {<<: *labels, omni.quantum.component: plausible-postgres}
    volumes: [plausible-postgres-data:/var/lib/postgresql/data]
    networks: [omni-quantum-network]

volumes:
  plausible-data:
  plausible-clickhouse-data:
  plausible-postgres-data:
networks:
  omni-quantum-network:
    external: true
